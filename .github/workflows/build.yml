name: Build

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Windows 64-bit
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install MinGW-w64
      run: sudo apt-get update && sudo apt-get install -y mingw-w64

    - name: Build for Windows 64-bit
      run: |
        make OS=cross CC=x86_64-w64-mingw32-gcc CXX=x86_64-w64-mingw32-g++
        mv ps3netsrv.exe ps3netsrv_win64.exe

    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ps3netsrv_win64
        path: ps3netsrv_win64.exe

  build-linux:
    name: Linux (${{ matrix.distro }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: ubuntu-latest
            image: ubuntu:latest
            install_cmd: apt-get update && apt-get install -y build-essential git
          - distro: debian-latest
            image: debian:latest
            install_cmd: apt-get update && apt-get install -y build-essential git
          - distro: fedora-latest
            image: fedora:latest
            install_cmd: dnf install -y gcc-c++ make git glibc-static libstdc++-static
          - distro: arch-latest
            image: archlinux:latest
            install_cmd: pacman -Syu --noconfirm base-devel git
          - distro: almalinux-latest
            image: almalinux:latest
            install_cmd: dnf install -y gcc-c++ make git glibc-static libstdc++-static

    container:
      image: ${{ matrix.image }}

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: ${{ matrix.install_cmd }}

    - name: Build
      run: |
        make OS=linux
        mv ps3netsrv ps3netsrv_${{ matrix.distro }}_x64

    - name: Upload Linux Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ps3netsrv_${{ matrix.distro }}_x64
        path: ps3netsrv_${{ matrix.distro }}_x64
