name: Build LuCI App

on:
  push:
    branches: [ "master", "main" ]
    paths:
      - 'luci-app-ps3netsrv/**'
      - '.github/workflows/luci.yml'
  pull_request:
    branches: [ "master", "main" ]
    paths:
      - 'luci-app-ps3netsrv/**'
      - '.github/workflows/luci.yml'
  workflow_dispatch:

jobs:
  build-ipk:
    name: Build LuCI IPK (OpenWrt 24.10.5)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Prepare build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential curl file gawk gettext git libncurses5-dev libssl-dev python3 rsync subversion sudo swig unzip wget zlib1g-dev zstd

    - name: Download SDK
      run: |
        # Using ath79/tiny as a small generic host for LuCI build
        BASE_URL="https://downloads.openwrt.org/releases/24.10.5/targets/ath79/tiny/"
        SDK_FILE=$(curl -s "$BASE_URL" | grep -o 'openwrt-sdk-[^"]*\.tar\.[a-z]*' | head -n 1)
        wget -q "$BASE_URL$SDK_FILE"
        mkdir sdk
        tar -xf "$SDK_FILE" -C sdk --strip-components=1
        rm "$SDK_FILE"

    - name: Configure SDK and Package
      run: |
        cd sdk
        mkdir -p package/luci-app-ps3netsrv
        cp -r $GITHUB_WORKSPACE/luci-app-ps3netsrv/* package/luci-app-ps3netsrv/
        
        # Switch to GitHub mirrors
        sed -i 's|https://git.openwrt.org/feed/|https://github.com/openwrt/|g' feeds.conf.default
        sed -i 's|https://git.openwrt.org/project/|https://github.com/openwrt/|g' feeds.conf.default
        sed -i 's|https://git.openwrt.org/openwrt/|https://github.com/openwrt/|g' feeds.conf.default

        ./scripts/feeds update -a
        ./scripts/feeds install -a
        make defconfig

    - name: Build LuCI App
      run: |
        cd sdk
        make package/luci-app-ps3netsrv/compile V=s

    - name: Prepare Artifact
      run: |
        IPK_FILE=$(find sdk/bin/packages -name "luci-app-ps3netsrv*.ipk" | head -n 1)
        echo "IPK_PATH=$IPK_FILE" >> $GITHUB_ENV
    
    - name: Upload IPK
      uses: actions/upload-artifact@v4
      with:
        name: luci-app-ps3netsrv_ipk
        path: ${{ env.IPK_PATH }}

  build-apk:
    name: Build LuCI APK (OpenWrt Snapshot)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Prepare build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential curl file gawk gettext git libncurses5-dev libssl-dev python3 rsync subversion sudo swig unzip wget zlib1g-dev zstd

    - name: Download SDK
      run: |
        BASE_URL="https://downloads.openwrt.org/snapshots/targets/ath79/tiny/"
        SDK_FILE=$(curl -s "$BASE_URL" | grep -o 'openwrt-sdk-[^"]*\.tar\.zst' | head -n 1)
        wget -q "$BASE_URL$SDK_FILE"
        mkdir sdk
        tar --zstd -xf "$SDK_FILE" -C sdk --strip-components=1
        rm "$SDK_FILE"

    - name: Configure SDK and Package
      run: |
        cd sdk
        mkdir -p package/luci-app-ps3netsrv
        cp -r $GITHUB_WORKSPACE/luci-app-ps3netsrv/* package/luci-app-ps3netsrv/
        
        # Switch to GitHub mirrors
        sed -i 's|https://git.openwrt.org/feed/|https://github.com/openwrt/|g' feeds.conf.default
        sed -i 's|https://git.openwrt.org/project/|https://github.com/openwrt/|g' feeds.conf.default
        sed -i 's|https://git.openwrt.org/openwrt/|https://github.com/openwrt/|g' feeds.conf.default

        ./scripts/feeds update -a
        ./scripts/feeds install -a
        make defconfig

    - name: Build LuCI App
      run: |
        cd sdk
        make package/luci-app-ps3netsrv/compile V=s

    - name: Prepare Artifact
      run: |
        # Try finding APK first, then IPK just in case
        PKG_FILE=$(find sdk/bin/packages -name "luci-app-ps3netsrv*.apk" | head -n 1)
        if [ -z "$PKG_FILE" ]; then
            PKG_FILE=$(find sdk/bin/packages -name "luci-app-ps3netsrv*.ipk" | head -n 1)
        fi
        echo "PKG_PATH=$PKG_FILE" >> $GITHUB_ENV
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: luci-app-ps3netsrv_apk
        path: ${{ env.PKG_PATH }}
